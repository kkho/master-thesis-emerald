head	1.5;
access;
symbols
	105alpha:1.4
	104alpha:1.3
	103alpha:1.3
	102alpha:1.3
	101alpha:1.3
	100alpha:1.3;
locks; strict;
comment	@# @;


1.5
date	2007.06.11.02.45.27;	author norm;	state Exp;
branches;
next	1.4;

1.4
date	98.08.11.19.29.08;	author norm;	state Exp;
branches;
next	1.3;

1.3
date	98.03.02.16.37.30;	author norm;	state Exp;
branches;
next	1.2;

1.2
date	98.02.23.16.20.26;	author norm;	state Exp;
branches;
next	1.1;

1.1
date	98.02.11.20.13.01;	author norm;	state Exp;
branches;
next	;


desc
@Generate the ccalls table.
@


1.5
log
@Check in current version
@
text
@#!/bin/csh -f
#
# Generate the tables and lists that drive the new ccalls mechanism

set allfiles = `cd $EMERALDROOT/ccalls ; emmake doths |& egrep -v 'Entering|Leaving'`
set selectedfiles = `echo $* | sed -e 's/\.o/.h/g'`
set ncctabc = cctab.c
set ncctabh = cctab.h
@@ moduleindex = 0

cp /dev/null $ncctabc
cp /dev/null $ncctabh

cat << THEEND >> $ncctabh
/*
 * $ncctabh
 *
 * THIS FILE IS AUTOMATICALLY GENERATED.  DO NOT EDIT.
 */

#ifndef _EMERALD_CCALLTAB_H
#define _EMERALD_CCALLTAB_H 1

typedef int (*ccallFunction)(void);

typedef struct CCallDescriptor {
  ccallFunction ccFunction;
  char* ccName;
  char* ccArgTemplate;
} CCallDescriptor;

extern CCallDescriptor *ccalltable[];
THEEND

cat << THEEND >> $ncctabc
/*
 * $ncctabc
 *
 * THIS FILE IS AUTOMATICALLY GENERATED.  DO NOT EDIT.
 */

#define E_NEEDS_STDIO_ONLY
#include "system.h"
#include "assert.h"
#include "$ncctabh"

THEEND
foreach file ($allfiles)
  set absfile = $EMERALDROOT/ccalls/$file
  set modulename = `echo $file:r | tr a-z A-Z`
  set selected = 0
  foreach i ($selectedfiles) 
    if ($i == $file) set selected = 1
  end
  if ($selected) then
    echo Generating $modulename
  else
    echo Skipping $modulename
    continue
  endif
  echo >> $ncctabc "CCallDescriptor ${modulename}_table[] = { "
  echo >> $ncctabh "#define ${modulename} $moduleindex"
  set ccs = `grep '^CCALL' $absfile | sed -e 's/CCALL *( *//' -e 's/,/ /g' -e 's/)//' -e 's/"//g' -e 's/;//' -e 's/\r//'`
  @@ i = 1
  @@ functionindex = 0
  if ($#ccs == 0) then
    echo >> $ncctabc \ \ \{ \(ccallFunction\) notselected, \"\", \"\" \},
  else
    while ($i < $#ccs)
      set functionname = $ccs[$i]
      @@ i ++
      set ccallname = $ccs[$i]
      @@ i ++
      set ccallstring = $ccs[$i]
      @@ i ++
      if ($selected) then
	echo >> $ncctabc \ \ \{ \(ccallFunction\) $functionname, \"$ccallname\", \"$ccallstring\" \},
	echo >> $ncctabh "extern int $functionname(void);"
      else
	echo >> $ncctabc \ \ \{ \(ccallFunction\) notselected, \"$ccallname\", \"$ccallstring\" \},
      endif
      echo >> $ncctabh "#define ${ccallname} $functionindex"
      @@ functionindex ++
    end
  endif
  echo >> $ncctabc "};"
  @@ moduleindex ++
end

echo >> $ncctabc "CCallDescriptor *ccalltable[] = {"
foreach absfile ($allfiles)
  set file = $absfile:t
  set selected = 0
  foreach i ($selectedfiles) 
    if ($i == $file) set selected = 1
  end
  if ($selected) then
    set modulename = `echo $file:r | tr a-z A-Z`
    echo >> $ncctabc "  ${modulename}_table,"
  else
    echo >> $ncctabc "  0,"
  endif
end
echo >> $ncctabc "};"
echo >> $ncctabh "#endif"
@


1.4
log
@Leave unselected CCTABs 0 to reduce the size
@
text
@d63 1
a63 1
  set ccs = `grep '^CCALL' $absfile | sed -e 's/CCALL *( *//' -e 's/,/ /g' -e 's/)//' -e 's/"//g' -e 's/;//'`
@


1.3
log
@'./bin'
@
text
@a46 5
static int notselected(void) 
{
  assert(0);
  return 1;
}
d59 1
d93 10
a102 2
  set modulename = `echo $file:r | tr a-z A-Z`
  echo >> $ncctabc "  ${modulename}_table,"
@


1.2
log
@'./bin'
@
text
@d42 2
@


1.1
log
@Initial revision
@
text
@d24 1
a24 1
typedef int (*ccallFunction)();
d80 1
a80 1
	echo >> $ncctabh "extern int $functionname();"
@
